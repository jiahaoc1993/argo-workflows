FROM csighub.tencentyun.com/dsn/argo-builder:v2.4.3 as argo-build   

####################################################################################################
# argoexec-base
# Used as the base for both the release and development version of argoexec                                                                                                                                                                                                               
####################################################################################################                                                                                                                                                                                      
FROM debian:10.0-slim as argoexec-base                                                                                                                                                                                                                                                     
# NOTE: keep the version synced with https://storage.googleapis.com/kubernetes-release/release/stable.txt                                                                                                                                                                                 
ENV KUBECTL_VERSION=1.16.3
RUN apt-get update && \                                                                                                                                                                                                                                                                   
    apt-get install -y curl jq procps git tar mime-support && \                                                                                                                                                                                                                           
    rm -rf /var/lib/apt/lists/* && \                                                                                                                                                                                                                                                      
    curl -L -o /usr/local/bin/kubectl -LO https://storage.googleapis.com/kubernetes-release/release/v${KUBECTL_VERSION}/bin/linux/arm64/kubectl && \                                                                                                                                      
    chmod +x /usr/local/bin/kubectl                                                                                                                                                                                                                                                       
COPY hack/ssh_known_hosts /etc/ssh/ssh_known_hosts                                                                                                                                                                                                                                        
COPY --from=argo-build /usr/local/bin/docker /usr/local/bin/  

                                                                                                                                                                                                                                                                                          
####################################################################################################                                                                                                                                                                                      
# argoexec                                                                                                                                                                                                                                                                                
####################################################################################################                                                                                                                                                                                      
FROM argoexec-base as argoexec                                                                                                                                                                                                                                                            
COPY --from=argo-build /go/src/github.com/argoproj/argo/dist/argoexec /usr/local/bin/    
